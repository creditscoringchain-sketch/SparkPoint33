<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        :root {
            --neon-green: #00ff9d;
            --gold: #ffd700;
            --bg-dark: #0f0f1b;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 400px; }

        .header { text-align: center; margin-bottom: 20px; }
        .logo { font-size: 1.8rem; font-weight: 900; letter-spacing: 2px; text-shadow: 0 0 10px var(--gold); }
        
        .wallet-info {
            font-size: 0.8rem; color: var(--gold); background: rgba(255, 215, 0, 0.1);
            padding: 8px; border-radius: 12px; margin: 10px 0; border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 15px; padding: 15px; text-align: center; }
        .stat-label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: #fff; }

        .matrix-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 20px; }
        .lvl-title { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--neon-green); margin: 15px 0 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        
        /* –°–µ—Ç–∫–∞ –∫—Ä—É–∂–∫–æ–≤ ‚Äî –¢–ï–ü–ï–†–¨ –í–´–†–ê–í–ù–ï–ù–û */
        .dots-grid { display: grid; gap: 10px; justify-content: center; margin-bottom: 10px; }
        #row1 { grid-template-columns: repeat(2, 25px); }
        #row2 { grid-template-columns: repeat(6, 25px); }
        #row3 { grid-template-columns: repeat(7, 25px); } /* 14 –º–µ—Å—Ç –≤ 2 —Ä—è–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ */

        .dot { width: 25px; height: 25px; border-radius: 50%; background: #222; border: 1px solid #444; transition: 0.3s; }
        .dot.active { background: var(--neon-green); box-shadow: 0 0 12px var(--neon-green); border: none; }

        .box { background: var(--card-bg); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-top: 15px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .btn-main { background: var(--neon-green); color: #000; }
        
        input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; border-radius: 10px; color: #fff; margin-top: 5px; box-sizing: border-box; }
        
        .admin-panel { border: 1px solid var(--gold); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">üí∞ SPARKPOINT</div>
        <div id="addrText" class="wallet-info hidden">...</div>
        <button id="btnConnect" class="btn btn-main" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
    </div>

    <div id="inviterBox" class="box hidden" style="text-align: center; font-size: 0.8rem;">
        ü§ù –í–∞—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª: <br><span id="invAddr" style="color: var(--neon-green); word-break: break-all;"></span>
    </div>

    <div class="stats-row">
        <div class="stat-box">
            <div class="stat-label">üöÄ –£—Ä–æ–≤–µ–Ω—å</div>
            <div id="statLvl" class="stat-value">-</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">üíé –ë–∞–ª–∞–Ω—Å</div>
            <div id="statBal" class="stat-value">0.00</div>
        </div>
    </div>

    <div class="matrix-card">
        <div class="lvl-title"><span>–£–†–û–í–ï–ù–¨ 1</span> <span>2 –ú–ï–°–¢–ê</span></div>
        <div id="row1" class="dots-grid"></div>

        <div class="lvl-title"><span>–£–†–û–í–ï–ù–¨ 2</span> <span>6 –ú–ï–°–¢</span></div>
        <div id="row2" class="dots-grid"></div>

        <div class="lvl-title"><span>–£–†–û–í–ï–ù–¨ 3</span> <span>14 –ú–ï–°–¢</span></div>
        <div id="row3" class="dots-grid"></div>
    </div>

    <div id="areaReg" class="box hidden">
        <div class="stat-label">–ê–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è</div>
        <input type="text" id="refInput" placeholder="0x...">
        <button class="btn btn-main" onclick="register()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å (0.001 BNB)</button>
    </div>

    <div id="areaLink" class="box hidden">
        <div class="stat-label">–í–∞—à–∞ —Å—Å—ã–ª–∫–∞</div>
        <input type="text" id="refLink" readonly>
        <button class="btn btn-main" onclick="copyLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å üîó</button>
    </div>

    <div id="areaAdmin" class="box admin-panel hidden">
        <b style="color: var(--gold);">üëë –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨</b>
        <input type="text" id="admNewU" placeholder="–ê–¥—Ä–µ—Å –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞">
        <input type="text" id="admNewR" placeholder="–ê–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è">
        <button class="btn" style="background: var(--gold); color: #000;" onclick="adminAdd()">–î–æ–±–∞–≤–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
    </div>
</div>

<script>
    const CONTRACT_ADDR = '0xd9145CCE52D386f254917e481eB44e9943F39138';
    const ABI = [{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"level","type":"uint256"}],"name":"LevelUp","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"Registered","type":"event"},{"stateMutability":"payable","type":"receive"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"level","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"partnersCount","type":"uint256"},{"internalType":"uint256","name":"structureCount","type":"uint256"},{"internalType":"uint256","name":"internalBalance","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"}];

    let web3, contract, currentUser;

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É—Å—Ç—ã—Ö –∫—Ä—É–∂–∫–æ–≤
    function initDots() {
        const draw = (id, n) => {
            const el = document.getElementById(id);
            el.innerHTML = '';
            for(let i=0; i<n; i++) el.innerHTML += '<div class="dot"></div>';
        };
        draw('row1', 2); draw('row2', 6); draw('row3', 14);
    }
    initDots();

    async function connect() {
        if(!window.ethereum) return alert("–£—Å—Ç–∞–Ω–æ–≤–∏ MetaMask!");
        const accs = await window.ethereum.request({method: 'eth_requestAccounts'});
        currentUser = accs[0];
        web3 = new Web3(window.ethereum);
        contract = new web3.eth.Contract(ABI, CONTRACT_ADDR);

        document.getElementById('btnConnect').classList.add('hidden');
        document.getElementById('addrText').classList.remove('hidden');
        document.getElementById('addrText').innerText = currentUser;

        await updateData();
    }

    async function updateData() {
        try {
            const userBox = await contract.methods.users(currentUser).call();
            const adminAddr = await contract.methods.admin().call();

            // –ï—Å–ª–∏ —Ç—ã –∞–¥–º–∏–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å—Ä–∞–∑—É
            if(currentUser.toLowerCase() === adminAddr.toLowerCase()) {
                document.getElementById('areaAdmin').classList.remove('hidden');
            }

            if(userBox.exists) {
                document.getElementById('areaReg').classList.add('hidden');
                document.getElementById('areaLink').classList.remove('hidden');
                document.getElementById('statLvl').innerText = userBox.level;
                document.getElementById('statBal').innerText = web3.utils.fromWei(userBox.internalBalance, 'ether');
                
                if(userBox.referrer !== '0x0000000000000000000000000000000000000000') {
                    document.getElementById('inviterBox').classList.remove('hidden');
                    document.getElementById('invAddr').innerText = userBox.referrer;
                }

                // –ó–∞–∂–∏–≥–∞–µ–º –∫—Ä—É–∂–∫–∏
                const p = parseInt(userBox.partnersCount);
                const s = parseInt(userBox.structureCount);
                const depth = s - p;

                const dots1 = document.getElementById('row1').children;
                for(let i=0; i<dots1.length; i++) if(i < p) dots1[i].classList.add('active');

                const dots2 = document.getElementById('row2').children;
                let l2 = Math.floor(depth / 2);
                for(let i=0; i<dots2.length; i++) if(i < l2) dots2[i].classList.add('active');

                const dots3 = document.getElementById('row3').children;
                let l3 = Math.floor(depth / 6);
                for(let i=0; i<dots3.length; i++) if(i < l3) dots3[i].classList.add('active');

                document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + currentUser;
            } else {
                document.getElementById('areaReg').classList.remove('hidden');
                document.getElementById('statLvl').innerText = "0";
            }
        } catch(e) { console.error(e); }
    }

    async function register() {
        const ref = document.getElementById('refInput').value || '0x0000000000000000000000000000000000000000';
        try {
            await contract.methods.register(ref).send({from: currentUser, value: web3.utils.toWei('0.001', 'ether')});
            location.reload();
        } catch(e) { alert("–û—à–∏–±–∫–∞!"); }
    }

    async function adminAdd() {
        const u = document.getElementById('admNewU').value;
        const r = document.getElementById('admNewR').value;
        if(!u || !r) return alert("–í–≤–µ–¥–∏ –∞–¥—Ä–µ—Å–∞!");
        try {
            await contract.methods.adminAddUser(u, r).send({from: currentUser});
            alert("–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!");
            location.reload();
        } catch(e) { alert("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ –∏ –≥–∞–∑."); }
    }

    function copyLink() {
        const copyText = document.getElementById("refLink");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
    }

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if(params.has('ref')) {
            document.getElementById('refInput').value = params.get('ref');
            document.getElementById('inviterBox').classList.remove('hidden');
            document.getElementById('invAddr').innerText = params.get('ref');
        }
    };
</script>
</body>
</html>
